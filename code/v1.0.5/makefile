ROOT_PATH := ../..
BUILD_DIR = $(ROOT_PATH)/build
IMAGE_OUTPUT_DIR = $(ROOT_PATH)/resources/hd60.img
ENTRY_POINT := 0xc0001500
# SECTOR çš„å¤§å°å°±æ˜¯ 512 Bytes
BLOCK_SIZE := 512
AS := nasm
CC := x86_64-elf-gcc
LD := x86_64-elf-ld
LIB := -I lib/ -I kernel/ -I device/ -I lib/kernel/
ASFLAGS := -f elf32 # ç¼–è¯‘æˆ x86 æ¶æ„ 32 ä½ elf
# debug
CFLAGS := -O0 -fno-builtin -c -Wall -m32 -W -Wstrict-prototypes -Wmissing-prototypes -DDEBUG
# online
# CFLAGS := -fno-builtin -c -Wall -m32 -W -Wstrict-prototypes -Wmissing-prototypes
LDFLAGS = -m elf_i386 -Ttext $(ENTRY_POINT) -e main
# å¯åŠ¨æ‰€éœ€å¯¹è±¡
STARTUP = $(BUILD_DIR)/mbr.bin $(BUILD_DIR)/loader.bin
# Kernel
OBJS = $(BUILD_DIR)/main.o $(BUILD_DIR)/print.o $(BUILD_DIR)/kernel.o $(BUILD_DIR)/interrupt.o $(BUILD_DIR)/init.o $(BUILD_DIR)/timer.o $(BUILD_DIR)/debug.o $(BUILD_DIR)/string.o
# ä¼ªç›®æ ‡å£°æ˜
.PHONY: build_dir_init clean send_program_to_disk build
# ======================== FUNC ========================
# åˆå§‹åŒ– build ç›®å½•
build_dir_init:
	@if [ ! -d "$(BUILD_DIR)" ]; then \
	  echo "ğŸ“ ç›®å½• $(BUILD_DIR) ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."; \
	  mkdir -p "$(BUILD_DIR)"; \
	  echo "ğŸ“ ç›®å½• $(BUILD_DIR) åˆ›å»ºæˆåŠŸï¼"; \
	else \
	  echo "ğŸ“ ç›®å½• $(BUILD_DIR) å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"; \
	fi
# æ¸…ç† build ç›®å½•
clean:
	@echo ğŸ˜´
# æ‹·è´ç¨‹åºåˆ°ç£ç›˜
# MBR åˆ°ç£ç›˜çš„ç¬¬ 1 ä¸ªæ‰‡åŒº
# LOADER åˆ°ç£ç›˜çš„ç¬¬ 3 ä¸ªæ‰‡åŒº
# KERNEL åˆ°ç£ç›˜çš„ç¬¬ 10 ä¸ªæ‰‡åŒº
send_program_to_disk:
	@dd if=$(BUILD_DIR)/mbr.bin of=$(IMAGE_OUTPUT_DIR) bs=$(BLOCK_SIZE) count=1 conv=notrunc && \
  dd if=$(BUILD_DIR)/loader.bin of=$(IMAGE_OUTPUT_DIR) bs=$(BLOCK_SIZE) count=4 seek=2 conv=notrunc && \
  dd if=$(BUILD_DIR)/kernel.bin of=$(IMAGE_OUTPUT_DIR) bs=$(BLOCK_SIZE) count=200 seek=9 conv=notrunc
build: $(BUILD_DIR)/kernel.bin
# ======================== æ±‡ç¼– =========================
# start
$(BUILD_DIR)/mbr.bin: boot/mbr.S
	$(AS) $< -o $@
$(BUILD_DIR)/loader.bin: boot/loader.S
	$(AS) $< -o $@
# kernel
$(BUILD_DIR)/print.o: lib/kernel/print.S
	$(AS) $(ASFLAGS) $< -o $@
$(BUILD_DIR)/kernel.o: kernel/kernel.S
	$(AS) $(ASFLAGS) $< -o $@
# ======================== C =========================
# lib
$(BUILD_DIR)/string.o: lib/string.c
	$(CC) $(LIB) $(CFLAGS) $< -o $@
# device
$(BUILD_DIR)/timer.o: device/timer.c
	$(CC) $(LIB) $(CFLAGS) $< -o $@
# kernel
$(BUILD_DIR)/interrupt.o: kernel/interrupt.c
	$(CC) $(LIB) $(CFLAGS) $< -o $@
$(BUILD_DIR)/init.o: kernel/init.c
	$(CC) $(LIB) $(CFLAGS) $< -o $@
$(BUILD_DIR)/debug.o: kernel/debug.c
	$(CC) $(LIB) $(CFLAGS) $< -o $@
$(BUILD_DIR)/main.o: kernel/main.c
	$(CC) $(LIB) $(CFLAGS) $< -o $@

# ======================== LINK =========================
$(BUILD_DIR)/kernel.bin: $(OBJS)
	$(LD) $(LDFLAGS) $^ -o $@
# ======================== MAIN =========================
all: build_dir_init build $(STARTUP) send_program_to_disk
	@echo "âœ… Compile done."
