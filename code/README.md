# 版本日志
- v1.0.0 
  - mbr + loader 
  - 保护模式开启打印字符
- v1.0.1
  - 物理内存容量检测
- v1.0.2
  - 保护模式 + 分页
- v1.0.3
  - 内核加载

# 资源配置
## 硬盘
hd60.img 磁盘使用(按照最新版本说明)

(512 Bytes per sector)

loader 预留 2 KB 的空间

kernel 预留 100 KB 的空间 

| 磁盘扇区索引 |  内容  |
| :----------: | :----: |
|      0       |  mbr   |
|      1       |        |
|      2       | loader |
|      3       | loader |
|      4       | loader |
|      5       | loader |
|      6       |        |
|      7       |        |
|      8       |        |
|      9       | kernel |
|     ...      |        |
|     208      | kernel |
## 内存
页表(page table) 4 KB

页表项(page table entry) 4 Bytes

一个页表里面有 1024[2^10] 个页表项存储的是物理地址

页表/目录项中仅使用高 20 位表示页表存储的高地址就行 低 12 位就是一些页表特征

为什么只用 20 位表示 因为 32 位计算机有 4GB 的理论空间

4 KB[2^12] 页划分 也就是 2^20 个块就能索引全局

计算第 n (索引从0开始)个表项目的物理地址 (n - 1) * 4

前提：kernel 只使用低端 1 MB 的地址 1 MB / 4 KB = 256 个页面

页表的第 256 项的物理地址 0x1013fc = 0x101000 + (256 - 1) * 4 [0x3fc]

PAGE_DIR_BASE_ADDR_IN_MEM 页表默认地址 0x100000 = 1 MB

此表为标记出符号位(低 12 bit)的值 应该为 0x7 [PAGE_P | PAGE_RW_W | PAGE_US_U]

内核在进程模型中占用高 1GB 空间 3GB~4GB

3G = 11000000_00000000_00000000_00000000 = 0xc0000000

取前 10 位为 1100000000 = 0x300 = 768 (页目录项索引)

所以第 769~1023 页目录项映射到第一个页面

| 地址(low -> high) |   内容   |                    备注                     |
| :---------------: | :------: | :-----------------------------------------: |
|     0x101FFC      |    0     | [第1个页表的最后1项] 1MB以上的空间不会使用  |
|        ...        |    0     |                   未使用                    |
|     0x101400      |    0     |  [第1个页表的第257项]->内核空间的下1个页面  |
|     0x1013FC      | 0x0FF000 | [第1个页表的第256项]->内核空间的最后1个页面 |
|        ...        |   ...    |                     ...                     |
|     0x101004      | 0x001000 |   [第1个页表的第2项]->内核空间的第2个页面   |
|     0x101000      | 0x000000 |   [第1个页表的第1项]->内核空间的第1个页面   |
|     0x100FFC      | 0x100000 |    [最后1个页(1024)目录项]->页目录表本身    |
|     0x100FF8      | 0x1FF000 |       [第1023个页目录项]->第255个页表       |
|        ...        |   ...    |                     ...                     |
|     0x100C04      | 0x102000 |        [第770个页目录项]->第2个页表         |
|     0x100C00      | 0x101000 |        [第769个页目录项]->第1个页表         |
|        ...        |    0     |                   未使用                    |
|     0x100000      | 0x101000 |         [第1个页目录项]->第1个页表          |
|     0x0FFFFF      |   ...    |                内核空间结束                 |
|        ...        |   ...    |                     ...                     |
|     0x000000      |   ...    |                内核空间开始                 |

# boch 调试
## 1.1 start & prepare

```shell
# 需要配置好环境
alias bochsd="bochs -debugger"
bochsd -f bochsrc.conf
```

## 1.2 常用命令

```shell
q 退出
b 添加地址断电
c 持续执行直到断点
trace on 启动汇编内容的打印
单步执行
s 遇到循环，则进入该命令在单步执行向显存写数据时，显存会刷新，但屏幕显示不会刷新
n 遇到循环，则跳过该命令在单步执行向显存写数据时，显存会刷新，屏幕显示也会刷新
```